(self.webpackChunk_N_E=self.webpackChunk_N_E||[]).push([[653],{63:(e,t,r)=>{"use strict";var a=r(7260);r.o(a,"useRouter")&&r.d(t,{useRouter:function(){return a.useRouter}})},796:(e,t,r)=>{Promise.resolve().then(r.bind(r,3426))},3426:(e,t,r)=>{"use strict";r.r(t),r.d(t,{default:()=>p});var a=r(5155),l=r(2115),o=r(63),s=r(8712);function n(e){var t,r,l,o,s,n,i,c,d;let{node:u,onClick:h,onConnectionStart:g,onConnectionEnd:p,isConnecting:f}=e;return(0,a.jsxs)("div",{className:"absolute flex flex-col justify-center items-start p-3 rounded-r-lg cursor-pointer ".concat((e=>{let t="border-l-4 shadow-lg backdrop-blur-sm bg-gray-900/90 transition-all hover:-translate-y-1 hover:shadow-xl";switch(e){case"crawler":return"".concat(t," border-blue-500 shadow-blue-900/20");case"translator":return"".concat(t," border-purple-500 shadow-purple-900/20");case"forwarder":return"".concat(t," border-orange-500 shadow-orange-900/20");case"formatter":return"".concat(t," border-pink-500 shadow-pink-900/20");case"target":return"".concat(t," border-green-500 shadow-green-900/20");default:return"".concat(t," border-gray-500")}})(u.type)),style:{left:u.x,top:u.y,width:u.width,height:u.height},onClick:()=>h(u),children:[(0,a.jsx)("div",{className:"text-white font-bold text-sm w-full break-words whitespace-normal leading-snug mb-1",title:u.label,children:u.label}),(0,a.jsx)("div",{className:"text-xs text-white/40 uppercase tracking-widest font-mono",children:u.type}),(null==(t=u.data)?void 0:t.enabled)===!1&&(0,a.jsx)("div",{className:"absolute top-2 right-2 w-2 h-2 rounded-full bg-red-500",title:"Disabled"}),("crawler"===u.type||"forwarder"===u.type)&&(null==(l=u.data)||null==(r=l.cfg_crawler)?void 0:r.cron)&&(0,a.jsx)("div",{className:"absolute bottom-2 right-2 text-[10px] text-white/50 font-mono bg-white/10 px-1 rounded",children:null==(s=u.data)||null==(o=s.cfg_crawler)?void 0:o.cron}),("crawler"===u.type||"forwarder"===u.type)&&(null==(i=u.data)||null==(n=i.cfg_forwarder)?void 0:n.cron)&&(0,a.jsx)("div",{className:"absolute bottom-2 right-2 text-[10px] text-white/50 font-mono bg-white/10 px-1 rounded",children:null==(d=u.data)||null==(c=d.cfg_forwarder)?void 0:c.cron}),("crawler"===u.type||"translator"===u.type||"formatter"===u.type)&&(0,a.jsx)("div",{className:"absolute right-0 top-1/2 -translate-y-1/2 translate-x-1/2 w-4 h-4 rounded-full bg-white/20 border-2 border-white/40 cursor-pointer hover:bg-white/40 hover:scale-125 transition-all z-10",onClick:e=>{e.stopPropagation(),null==g||g(u.id,"output")},title:"Drag to connect"}),("translator"===u.type||"formatter"===u.type||"target"===u.type)&&(0,a.jsx)("div",{className:"absolute left-0 top-1/2 -translate-y-1/2 -translate-x-1/2 w-4 h-4 rounded-full bg-white/20 border-2 border-white/40 cursor-pointer hover:bg-white/40 hover:scale-125 transition-all z-10",onClick:e=>{e.stopPropagation(),null==p||p(u.id,"input")},onMouseEnter:e=>{f&&e.target.classList.add("!bg-green-400","!border-green-500")},onMouseLeave:e=>{e.target.classList.remove("!bg-green-400","!border-green-500")},title:"Connect here"})]})}function i(e){let{node:t,onSave:r,onClose:o,availableCookies:s=[]}=e,[n,i]=(0,l.useState)({}),[h,g]=(0,l.useState)(""),[p,f]=(0,l.useState)(!1);(0,l.useEffect)(()=>{var e,r,a,l,o,s,n,c,d,u,h,g,p,f,b,m,x,w,_;if("crawler"===t.type){let d=t.data;i({name:d.name,task_type:d.task_type||"article",cron:(null==(e=d.cfg_crawler)?void 0:e.cron)||"",cookie_file:(null==(r=d.cfg_crawler)?void 0:r.cookie_file)||"",engine:(null==(a=d.cfg_crawler)?void 0:a.engine)||"browser",websites:d.websites?d.websites.join("\n"):"",origin:d.origin||"",paths:d.paths?d.paths.join("\n"):"",sub_task_type:(null==(l=d.cfg_crawler)?void 0:l.sub_task_type)?d.cfg_crawler.sub_task_type.join("\n"):"",interval_min:(null==(s=d.cfg_crawler)||null==(o=s.interval_time)?void 0:o.min)||"",interval_max:(null==(c=d.cfg_crawler)||null==(n=c.interval_time)?void 0:n.max)||""})}else if("translator"===t.type){let e=t.data;i({provider:e.provider||"Google",api_key:e.api_key||"",model_id:(null==(d=e.cfg_translator)?void 0:d.model_id)||"",prompt:(null==(u=e.cfg_translator)?void 0:u.prompt)||"",base_url:(null==(h=e.cfg_translator)?void 0:h.base_url)||""})}else if("forwarder"===t.type){let e=t.data;i({name:e.name,task_type:e.task_type||"article",cron:(null==(g=e.cfg_forwarder)?void 0:g.cron)||"",render_type:(null==(p=e.cfg_forwarder)?void 0:p.render_type)||"text",websites:e.websites?e.websites.join("\n"):"",origin:e.origin||"",paths:e.paths?e.paths.join("\n"):"",task_title:e.task_title||"",subscribers:e.subscribers?e.subscribers.map(e=>"string"==typeof e?e:e.id):[],accept_keywords:(null==(f=e.cfg_forward_target)?void 0:f.accept_keywords)?e.cfg_forward_target.accept_keywords.join("\n"):"",filter_keywords:(null==(b=e.cfg_forward_target)?void 0:b.filter_keywords)?e.cfg_forward_target.filter_keywords.join("\n"):""})}else if("formatter"===t.type)i({render_type:t.data.render_type||"text"});else if("target"===t.type){let e=t.data,r=e.cfg_platform||{};i({platform:e.platform,id:e.id,replace_regex:JSON.stringify((null==(m=e.cfg_platform)?void 0:m.replace_regex)||"",null,2),block_until:(null==(x=e.cfg_platform)?void 0:x.block_until)||"",accept_keywords:(null==(w=e.cfg_platform)?void 0:w.accept_keywords)?e.cfg_platform.accept_keywords.join("\n"):"",filter_keywords:(null==(_=e.cfg_platform)?void 0:_.filter_keywords)?e.cfg_platform.filter_keywords.join("\n"):"",tg_token:r.token||"",tg_chat_id:r.chat_id||"",qq_url:r.url||"",qq_group_id:r.group_id||"",qq_token:r.token||"",bili_sessdata:r.sessdata||"",bili_jct:r.bili_jct||"",bili_media_check:r.media_check_level||"loose",json_config:JSON.stringify(e.cfg_platform,null,2)})}},[t]);let b=(e,t)=>{i(r=>({...r,[e]:t}))},m=async e=>{if(e){f(!0);try{let t=await fetch("/api/cookies/view/".concat(encodeURIComponent(e.replace(".txt",""))));if(!t.ok)throw Error("Failed to fetch cookie file");let r=(await t.json()).content.split("\n"),a="",l="";for(let e of r){if(e.startsWith("#")||!e.trim())continue;let t=e.split("	");if(t.length>=7){let e=t[5],r=t[6];"SESSDATA"===e&&(a=r.trim()),"bili_jct"===e&&(l=r.trim())}}a&&l?(i(e=>({...e,bili_sessdata:a,bili_jct:l})),alert("Successfully imported credentials from ".concat(e))):alert("Could not find SESSDATA or bili_jct in the selected cookie file.")}catch(e){alert("Import failed: ".concat(e.message))}finally{f(!1)}}};return(0,a.jsx)("div",{className:"fixed inset-0 bg-black/50 backdrop-blur-sm flex items-center justify-center z-50 p-8",children:(0,a.jsxs)("div",{className:"bg-gray-900 border border-white/20 rounded-2xl w-full max-w-2xl max-h-full overflow-y-auto shadow-2xl flex flex-col",children:[(0,a.jsxs)("div",{className:"p-6 border-b border-white/10 flex justify-between items-center",children:[(0,a.jsxs)("h2",{className:"text-2xl font-bold text-white flex items-center gap-2",children:["Config: ",t.label]}),(0,a.jsx)("button",{onClick:o,className:"text-white/60 hover:text-white",children:"✕"})]}),(0,a.jsxs)("div",{className:"p-6 space-y-6 flex-grow overflow-auto",children:["crawler"===t.type&&(0,a.jsxs)(a.Fragment,{children:[(0,a.jsxs)("div",{className:"grid grid-cols-2 gap-4",children:[(0,a.jsx)(c,{label:"Name",value:n.name,onChange:e=>b("name",e)}),(0,a.jsx)(u,{label:"Task Type",value:n.task_type,options:["article","follows"],onChange:e=>b("task_type",e)})]}),(0,a.jsx)("h3",{className:"text-sm font-bold text-blue-300 border-b border-blue-500/30 pb-1 mt-4",children:"Target Source"}),(0,a.jsx)(c,{label:"Origin (e.g. Username)",value:n.origin,onChange:e=>b("origin",e),placeholder:"@username"}),(0,a.jsx)(d,{label:"Paths (e.g. List ID)",value:n.paths,onChange:e=>b("paths",e),placeholder:"One path per line"}),(0,a.jsx)(d,{label:"Websites (Override)",value:n.websites,onChange:e=>b("websites",e),placeholder:"https://..."}),(0,a.jsx)("h3",{className:"text-sm font-bold text-blue-300 border-b border-blue-500/30 pb-1 mt-4",children:"Execution"}),(0,a.jsxs)("div",{className:"grid grid-cols-2 gap-4",children:[(0,a.jsx)(c,{label:"Cron Schedule",value:n.cron,onChange:e=>b("cron",e),placeholder:"* * * * *"}),(0,a.jsx)(u,{label:"Engine",value:n.engine,options:["browser","cheerio","axios"],onChange:e=>b("engine",e)})]}),(0,a.jsx)(u,{label:"Cookie File",value:n.cookie_file,options:["",...s],onChange:e=>b("cookie_file",e)}),(0,a.jsxs)("div",{className:"grid grid-cols-2 gap-4",children:[(0,a.jsx)(c,{label:"Interval Min (ms)",value:n.interval_min,onChange:e=>b("interval_min",e),type:"number"}),(0,a.jsx)(c,{label:"Interval Max (ms)",value:n.interval_max,onChange:e=>b("interval_max",e),type:"number"})]}),(0,a.jsx)(d,{label:"Sub Task Types",value:n.sub_task_type,onChange:e=>b("sub_task_type",e),placeholder:"One per line"})]}),"translator"===t.type&&(0,a.jsxs)(a.Fragment,{children:[(0,a.jsx)("div",{className:"mb-4 bg-blue-500/10 p-3 rounded border border-blue-500/30 text-xs text-blue-200",children:"This translator profile is attached to the crawler."}),(0,a.jsx)(u,{label:"Provider",value:n.provider,options:["Google","BigModel","Deepseek","Openai","ByteDance","None"],onChange:e=>b("provider",e)}),(0,a.jsx)(c,{label:"API Key",value:n.api_key,onChange:e=>b("api_key",e),type:"password"}),(0,a.jsx)(c,{label:"Base URL",value:n.base_url,onChange:e=>b("base_url",e),placeholder:"Optional"}),(0,a.jsx)(c,{label:"Model ID",value:n.model_id,onChange:e=>b("model_id",e)}),(0,a.jsx)(d,{label:"System Prompt",value:n.prompt,onChange:e=>b("prompt",e)})]}),"forwarder"===t.type&&(0,a.jsxs)(a.Fragment,{children:[(0,a.jsxs)("div",{className:"grid grid-cols-2 gap-4",children:[(0,a.jsx)(c,{label:"Name",value:n.name,onChange:e=>b("name",e)}),(0,a.jsx)(c,{label:"Task Title",value:n.task_title,onChange:e=>b("task_title",e)})]}),(0,a.jsx)(u,{label:"Task Type",value:n.task_type,options:["article","follows"],onChange:e=>b("task_type",e)}),(0,a.jsx)("h3",{className:"text-sm font-bold text-orange-300 border-b border-orange-500/30 pb-1 mt-4",children:"Source Matcher"}),(0,a.jsx)("div",{className:"text-xs text-white/50 mb-2",children:"Configure these to match the source Crawler."}),(0,a.jsx)(c,{label:"Origin (Username)",value:n.origin,onChange:e=>b("origin",e)}),(0,a.jsx)(d,{label:"Paths (List ID)",value:n.paths,onChange:e=>b("paths",e)}),(0,a.jsx)(d,{label:"Websites (Exact URL)",value:n.websites,onChange:e=>b("websites",e)}),(0,a.jsx)("h3",{className:"text-sm font-bold text-orange-300 border-b border-orange-500/30 pb-1 mt-4",children:"Formatter & Execution"}),(0,a.jsx)(u,{label:"Render Type (Formatter)",value:n.render_type,options:[{label:"Text Only",value:"text"},{label:"Standard Image Card",value:"img"},{label:"Image with Metadata",value:"img-with-meta"},{label:"Image with Source Label",value:"img-with-source"},{label:"Image with Source + Summary",value:"img-with-source-summary"}],onChange:e=>b("render_type",e)}),(0,a.jsx)(c,{label:"Execution Cron",value:n.cron,onChange:e=>b("cron",e),placeholder:"* * * * *"}),(0,a.jsxs)("div",{className:"grid grid-cols-2 gap-4",children:[(0,a.jsx)(d,{label:"Accept Keywords",value:n.accept_keywords,onChange:e=>b("accept_keywords",e),placeholder:"One per line",fontMono:!0}),(0,a.jsx)(d,{label:"Filter Keywords (Block)",value:n.filter_keywords,onChange:e=>b("filter_keywords",e),placeholder:"One per line",fontMono:!0})]})]}),"formatter"===t.type&&(0,a.jsxs)(a.Fragment,{children:[(0,a.jsx)("div",{className:"mb-4 bg-pink-500/10 p-3 rounded border border-pink-500/30 text-xs text-pink-200",children:"This formatter determines how content is rendered before sending to targets."}),(0,a.jsx)(u,{label:"Format / Layout",value:n.render_type,options:[{label:"Text Only",value:"text"},{label:"Standard Image Card",value:"img"},{label:"Image with Metadata",value:"img-with-meta"},{label:"Image with Source Label",value:"img-with-source"},{label:"Image with Source + Summary",value:"img-with-source-summary"}],onChange:e=>b("render_type",e)})]}),"target"===t.type&&(0,a.jsxs)(a.Fragment,{children:[(0,a.jsx)(u,{label:"Platform",value:n.platform,options:["telegram","bilibili","qq","none"],onChange:e=>b("platform",e)}),(0,a.jsx)(c,{label:"Unique ID (Optional)",value:n.id,onChange:e=>b("id",e),placeholder:"Leave blank for auto-hash"}),(0,a.jsxs)("div",{className:"p-4 bg-white/5 rounded-lg border border-white/10 space-y-4",children:["telegram"===n.platform&&(0,a.jsxs)(a.Fragment,{children:[(0,a.jsx)("h3",{className:"font-bold text-sm text-blue-300",children:"Telegram"}),(0,a.jsx)(c,{label:"Bot Token",value:n.tg_token,onChange:e=>b("tg_token",e)}),(0,a.jsx)(c,{label:"Chat ID",value:n.tg_chat_id,onChange:e=>b("tg_chat_id",e)})]}),"qq"===n.platform&&(0,a.jsxs)(a.Fragment,{children:[(0,a.jsx)("h3",{className:"font-bold text-sm text-blue-300",children:"QQ"}),(0,a.jsx)(c,{label:"API URL",value:n.qq_url,onChange:e=>b("qq_url",e)}),(0,a.jsx)(c,{label:"Token",value:n.qq_token,onChange:e=>b("qq_token",e)}),(0,a.jsx)(c,{label:"Group ID",value:n.qq_group_id,onChange:e=>b("qq_group_id",e)})]}),"bilibili"===n.platform&&(0,a.jsxs)(a.Fragment,{children:[(0,a.jsx)("h3",{className:"font-bold text-sm text-pink-300",children:"Bilibili"}),(0,a.jsx)("div",{className:"flex gap-2 items-end",children:(0,a.jsx)(u,{label:"Import from Cookie",value:"",options:["...",...s],onChange:m})}),(0,a.jsx)(c,{label:"SESSDATA",value:n.bili_sessdata,onChange:e=>b("bili_sessdata",e),type:"password"}),(0,a.jsx)(c,{label:"Bili JCT",value:n.bili_jct,onChange:e=>b("bili_jct",e),type:"password"})]})]}),(0,a.jsxs)("div",{className:"mt-4 pt-4 border-t border-white/10",children:[(0,a.jsx)("h3",{className:"font-bold text-sm text-white/60 mb-2",children:"Global Rules"}),(0,a.jsxs)("div",{className:"grid grid-cols-2 gap-4",children:[(0,a.jsx)(d,{label:"Accept Keywords",value:n.accept_keywords,onChange:e=>b("accept_keywords",e),placeholder:"One per line",fontMono:!0}),(0,a.jsx)(d,{label:"Filter Keywords",value:n.filter_keywords,onChange:e=>b("filter_keywords",e),placeholder:"One per line",fontMono:!0})]}),(0,a.jsx)(d,{label:"Replace Regex (String or JSON)",value:n.replace_regex,onChange:e=>b("replace_regex",e),fontMono:!0}),(0,a.jsx)(c,{label:"Block Until (Time)",value:n.block_until,onChange:e=>b("block_until",e),placeholder:"e.g. 1h"})]})]})]}),(0,a.jsxs)("div",{className:"p-6 border-t border-white/10 bg-black/20 flex justify-end gap-3",children:[(0,a.jsx)("button",{onClick:o,className:"px-4 py-2 rounded-lg text-white/70 hover:bg-white/10 transition-colors",children:"Cancel"}),(0,a.jsx)("button",{onClick:()=>{let e={...t.data},a=e=>e?e.split("\n").map(e=>e.trim()).filter(Boolean):void 0;if("crawler"===t.type)e.name=n.name,e.task_type=n.task_type,e.websites=a(n.websites),e.origin=n.origin,e.paths=a(n.paths),e.cfg_crawler||(e.cfg_crawler={}),e.cfg_crawler.cron=n.cron,e.cfg_crawler.cookie_file=n.cookie_file,e.cfg_crawler.engine=n.engine,e.cfg_crawler.sub_task_type=a(n.sub_task_type),(n.interval_min||n.interval_max)&&(e.cfg_crawler.interval_time={min:parseInt(n.interval_min)||0,max:parseInt(n.interval_max)||0});else if("translator"===t.type)e.provider=n.provider,e.api_key=n.api_key,e.cfg_translator||(e.cfg_translator={}),e.cfg_translator.model_id=n.model_id,e.cfg_translator.prompt=n.prompt,e.cfg_translator.base_url=n.base_url;else if("forwarder"===t.type)e.name=n.name,e.task_type=n.task_type,e.task_title=n.task_title,e.websites=a(n.websites),e.origin=n.origin,e.paths=a(n.paths),e.cfg_forwarder||(e.cfg_forwarder={}),e.cfg_forwarder.cron=n.cron,e.cfg_forwarder.render_type=n.render_type,e.cfg_forward_target||(e.cfg_forward_target={}),e.cfg_forward_target.accept_keywords=a(n.accept_keywords),e.cfg_forward_target.filter_keywords=a(n.filter_keywords);else if("formatter"===t.type)e.render_type=n.render_type;else if("target"===t.type){e.platform=n.platform,e.id=n.id;let t={};if("telegram"===n.platform)t.token=n.tg_token,t.chat_id=n.tg_chat_id;else if("qq"===n.platform)t.url=n.qq_url,t.group_id=n.qq_group_id,t.token=n.qq_token;else if("bilibili"===n.platform)t.sessdata=n.bili_sessdata,t.bili_jct=n.bili_jct,t.media_check_level=n.bili_media_check;else try{let e=JSON.parse(n.json_config||"{}");Object.assign(t,e)}catch(e){}try{n.replace_regex&&(n.replace_regex.trim().startsWith("[")||n.replace_regex.trim().startsWith('"'))?t.replace_regex=JSON.parse(n.replace_regex):t.replace_regex=n.replace_regex}catch(e){t.replace_regex=n.replace_regex}n.block_until&&(t.block_until=n.block_until),t.accept_keywords=a(n.accept_keywords),t.filter_keywords=a(n.filter_keywords),e.cfg_platform=t}r(t,e)},className:"px-4 py-2 bg-blue-600 hover:bg-blue-700 text-white rounded-lg transition-colors font-medium",children:"Save Changes"})]})]})})}function c(e){let{label:t,value:r,onChange:l,type:o="text",placeholder:s}=e;return(0,a.jsxs)("div",{children:[(0,a.jsx)("label",{className:"block text-sm font-medium text-white/80 mb-1",children:t}),(0,a.jsx)("input",{type:o,value:r||"",onChange:e=>l(e.target.value),placeholder:s,className:"w-full px-4 py-2 bg-black/30 border border-white/10 rounded-lg text-white placeholder-white/30 focus:outline-none focus:ring-2 focus:ring-blue-500"})]})}function d(e){let{label:t,value:r,onChange:l,fontMono:o}=e;return(0,a.jsxs)("div",{children:[(0,a.jsx)("label",{className:"block text-sm font-medium text-white/80 mb-1",children:t}),(0,a.jsx)("textarea",{rows:4,value:r||"",onChange:e=>l(e.target.value),className:"w-full px-4 py-2 bg-black/30 border border-white/10 rounded-lg text-white placeholder-white/30 focus:outline-none focus:ring-2 focus:ring-blue-500 ".concat(o?"font-mono text-xs":"")})]})}function u(e){let{label:t,value:r,options:l,onChange:o}=e;return(0,a.jsxs)("div",{className:"flex-grow",children:[(0,a.jsx)("label",{className:"block text-sm font-medium text-white/80 mb-1",children:t}),(0,a.jsx)("select",{value:r||"",onChange:e=>o(e.target.value),className:"w-full px-4 py-2 bg-black/30 border border-white/10 rounded-lg text-white focus:outline-none focus:ring-2 focus:ring-blue-500 appearance-none",children:l.map(e=>{let t="object"==typeof e?e.label:e,r="object"==typeof e?e.value:e;return(0,a.jsx)("option",{value:r,children:t},r)})})]})}var h=r(6671),g=r.n(h);function p(){let{user:e,loading:t}=(0,s.A)(),r=(0,o.useRouter)(),[c,d]=(0,l.useState)(null),[u,h]=(0,l.useState)([]),[p,f]=(0,l.useState)([]),[b,m]=(0,l.useState)(!1),[x,w]=(0,l.useState)(""),[_,v]=(0,l.useState)(null),[y,j]=(0,l.useState)(!1),[k,C]=(0,l.useState)(null),[N,S]=(0,l.useState)(!1);(0,l.useEffect)(()=>{t||e||r.push("/auth/login?redirect=/config")},[e,t,r]),(0,l.useEffect)(()=>{e&&O()},[e]);let[T,E]=(0,l.useState)([]),O=async()=>{m(!0),w("");try{let[e,t]=await Promise.all([fetch("/api/config"),fetch("/api/cookies/list")]);if(401===e.status||401===t.status)return void r.push("/auth/login?redirect=/config");if(!e.ok)throw Error("Failed to fetch config");let a=await e.json();if(d(a),q(a),t.ok){let e=await t.json();E(e.map(e=>e.filename))}}catch(e){w(e instanceof Error?e.message:"Failed to load data")}finally{m(!1)}},q=e=>{let t=[],r=[],a=e.crawlers||[],l=e.forwarders||[],o=e.forward_targets||[],s=new Set;l.forEach(e=>{var t;let r=(null==(t=e.cfg_forwarder)?void 0:t.render_type)||"text";s.add(r)});let n=Array.from(s);a.forEach((e,a)=>{var l;let o="crawler-".concat(a);if(t.push({id:o,type:"crawler",label:e.name||"Crawler ".concat(a+1),data:e,x:50,y:120*a+100,width:250,height:100}),null==(l=e.cfg_crawler)?void 0:l.translator){let l="translator-".concat(a);t.push({id:l,type:"translator",label:"LLM Processor (".concat(e.cfg_crawler.translator.provider,")"),data:e.cfg_crawler.translator,x:400,y:120*a+100,width:250,height:100,parentId:o}),r.push({id:"conn-c-t-".concat(a),source:o,target:l})}}),n.forEach((e,a)=>{let l="formatter-".concat(a),s=120*a+100,n=(()=>{switch(e){case"text":return"Text Only";case"img":return"Image Card";case"img-with-meta":return"Image + Meta";case"img-with-source":return"Image + Source";case"img-with-source-summary":return"Image + Source + Summary";default:return e}})();t.push({id:l,type:"formatter",label:n,data:{render_type:e},x:750,y:s,width:250,height:100}),o[a]&&r.push({id:"conn-fmt-t-".concat(a),source:l,target:"target-".concat(a)})}),a.forEach((e,t)=>{var a,o;let s=(null==(a=e.cfg_crawler)?void 0:a.translator)?"translator-".concat(t):"crawler-".concat(t),i=l[t];if(i){let e=(null==(o=i.cfg_forwarder)?void 0:o.render_type)||"text",a=n.indexOf(e);a>=0&&r.push({id:"conn-src-fmt-".concat(t),source:s,target:"formatter-".concat(a)})}}),o.forEach((e,r)=>{t.push({id:"target-".concat(r),type:"target",label:"".concat(e.platform," (").concat(e.id||"Global",")"),data:e,x:1100,y:120*r+100,width:250,height:100})}),h(t),f(r)},I=async(e,t)=>{if(!c)return;let r=g().cloneDeep(c),[a,l]=e.id.split("-"),o=parseInt(l);if("crawler"===a)r.crawlers&&r.crawlers[o]&&(r.crawlers[o]=t);else if("translator"===a)r.crawlers&&r.crawlers[o]&&(r.crawlers[o].cfg_crawler||(r.crawlers[o].cfg_crawler={}),r.crawlers[o].cfg_crawler.translator=t);else if("forwarder"===a)r.forwarders&&r.forwarders[o]&&(r.forwarders[o]=t);else if("formatter"===a){let a=e.data.render_type,l=t.render_type;r.forwarders&&r.forwarders.forEach(e=>{var t;(null==(t=e.cfg_forwarder)?void 0:t.render_type)===a&&(e.cfg_forwarder||(e.cfg_forwarder={}),e.cfg_forwarder.render_type=l)})}else"target"===a&&r.forward_targets&&r.forward_targets[o]&&(r.forward_targets[o]=t);d(r),q(r),C(null);try{if(v("Saving..."),!(await fetch("/api/config/update",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify(r)})).ok)throw Error("Failed to save to backend");v("Saved successfully! Restart server to apply.")}catch(e){v("Error saving: ".concat(e.message))}},R=async()=>{if(confirm("Are you sure you want to restart the backend server? This will interrupt active tasks.")){S(!0),v("Restarting server...");try{if(!(await fetch("/api/server/restart",{method:"POST"})).ok)throw Error("Restart request failed");v("Server restart command sent. Please wait for service to recover."),setTimeout(()=>{S(!1),v("Server should be back up. Refresh if needed.")},5e3)}catch(e){v("Restart Error: ".concat(e.message)),S(!1)}}};return t||!e?(0,a.jsx)("div",{className:"min-h-screen bg-black flex items-center justify-center text-white",children:"Loading..."}):(0,a.jsxs)("div",{className:"min-h-screen bg-[#111] text-white overflow-hidden flex flex-col",children:[(0,a.jsxs)("div",{className:"bg-[#1a1a1a] border-b border-white/10 p-4 flex justify-between items-center z-10 shadow-md",children:[(0,a.jsxs)("div",{className:"flex items-center gap-3",children:[(0,a.jsxs)("h1",{className:"text-xl font-bold flex items-center gap-2",children:[(0,a.jsx)("span",{children:"⚙️"})," Configuration Graph"]}),_&&(0,a.jsx)("span",{className:"text-xs px-2 py-1 rounded ".concat(_.includes("Error")?"bg-red-500/20 text-red-300":"bg-green-500/20 text-green-300"),children:_})]}),(0,a.jsxs)("div",{className:"flex gap-3",children:[(0,a.jsx)("button",{onClick:()=>j(!y),className:"px-3 py-1 rounded text-sm transition-colors ".concat(y?"bg-purple-600 text-white":"bg-white/5 hover:bg-white/10"),children:"Debug Info"}),(0,a.jsx)("button",{onClick:O,className:"px-3 py-1 bg-white/5 hover:bg-white/10 rounded text-sm transition-colors",disabled:b,children:"Refresh"}),(0,a.jsx)("button",{onClick:R,disabled:N,className:"px-3 py-1 bg-red-600 hover:bg-red-700 text-white rounded text-sm transition-colors flex items-center gap-2 ".concat(N?"opacity-50 cursor-not-allowed":""),children:N?"Restarting...":"Restart Server"})]})]}),(0,a.jsx)("div",{className:"flex-grow relative overflow-auto bg-[url('/grid.svg')] bg-fixed",style:{backgroundSize:"20px 20px"},children:(0,a.jsxs)("div",{className:"absolute inset-0 min-w-[1500px] min-h-[1000px]",children:[(0,a.jsx)("svg",{className:"absolute inset-0 w-full h-full pointer-events-none z-0",children:p.map(e=>{let t=u.find(t=>t.id===e.source),r=u.find(t=>t.id===e.target);if(!t||!r)return null;let l=t.x+t.width,o=t.y+t.height/2,s=r.x,n=r.y+r.height/2;return(0,a.jsx)("path",{d:"M ".concat(l," ").concat(o," C ").concat(l+50," ").concat(o,", ").concat(s-50," ").concat(n,", ").concat(s," ").concat(n),fill:"none",stroke:"#555",strokeWidth:"2",strokeDasharray:"5,5"},e.id)})}),0===u.length&&!b&&(0,a.jsx)("div",{className:"absolute inset-0 flex items-center justify-center pointer-events-none",children:(0,a.jsxs)("div",{className:"text-center p-8 bg-black/50 backdrop-blur-md rounded-xl border border-white/10 select-none pointer-events-auto",children:[(0,a.jsx)("div",{className:"text-4xl mb-4",children:"\uD83D\uDD78️"}),(0,a.jsx)("h3",{className:"text-xl font-bold text-white mb-2",children:"No Configuration Found"}),(0,a.jsxs)("p",{className:"text-white/60 max-w-md",children:["The crawler/forwarder graph is empty. Please check your backend ",(0,a.jsx)("code",{children:"config.yaml"})," or check console for errors."]})]})}),u.map(e=>(0,a.jsx)(n,{node:e,onClick:e=>C(e)},e.id)),(0,a.jsx)("div",{className:"absolute top-4 left-[50px] text-white/20 font-bold text-xl",children:"CRAWLERS"}),(0,a.jsx)("div",{className:"absolute top-4 left-[400px] text-white/20 font-bold text-xl",children:"TRANSLATORS"}),(0,a.jsx)("div",{className:"absolute top-4 left-[750px] text-white/20 font-bold text-xl",children:"FORWARDERS"}),(0,a.jsx)("div",{className:"absolute top-4 left-[1100px] text-white/20 font-bold text-xl",children:"FORMATTERS"}),(0,a.jsx)("div",{className:"absolute top-4 left-[1450px] text-white/20 font-bold text-xl",children:"TARGETS"})]})}),y&&c&&(0,a.jsxs)("div",{className:"h-64 border-t border-white/10 bg-black/90 p-4 font-mono text-xs overflow-auto",children:[(0,a.jsxs)("div",{className:"flex justify-between items-center mb-2",children:[(0,a.jsx)("h3",{className:"font-bold text-lg text-purple-300",children:"Backend Config Debug"}),(0,a.jsx)("button",{onClick:()=>j(!1),className:"text-white/60 hover:text-white",children:"✕ Close"})]}),(0,a.jsx)("pre",{className:"text-green-400 whitespace-pre-wrap",children:JSON.stringify(c,null,2)})]}),k&&c&&(0,a.jsx)(i,{node:k,fullConfig:c,availableCookies:T,onSave:I,onClose:()=>C(null)})]})}},8712:(e,t,r)=>{"use strict";r.d(t,{WithAuth:()=>i,A:()=>n});var a=r(5155),l=r(2115);let o=(0,l.createContext)(void 0);function s(e){let{children:t}=e,[r,s]=(0,l.useState)(null),[n,i]=(0,l.useState)(!0),c=async()=>{try{let e=await fetch("/api/auth/me",{credentials:"include"});if(e.ok){let t=await e.json();s(t)}else s(null)}catch(e){console.error("Failed to fetch user:",e),s(null)}finally{i(!1)}},d=async(e,t)=>{try{let r=await fetch("/api/auth/login",{method:"POST",headers:{"Content-Type":"application/json"},credentials:"include",body:JSON.stringify({username:e,password:t})});if(r.ok){let e=await r.json();return s(e),!0}return!1}catch(e){return console.error("Login failed:",e),!1}},u=async()=>{try{await fetch("/api/auth/logout",{method:"POST",credentials:"include"})}catch(e){console.error("Logout failed:",e)}s(null)},h=async()=>{await c()};return(0,l.useEffect)(()=>{c()},[]),(0,a.jsx)(o.Provider,{value:{user:r,loading:n,login:d,logout:u,refreshUser:h},children:t})}function n(){let e=(0,l.useContext)(o);if(void 0===e)throw Error("useAuth must be used within an AuthProvider");return e}function i(e){let{children:t}=e;return(0,a.jsx)(s,{children:t})}}},e=>{e.O(0,[935,441,255,358],()=>e(e.s=796)),_N_E=e.O()}]);