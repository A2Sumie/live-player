(self.webpackChunk_N_E=self.webpackChunk_N_E||[]).push([[653],{63:(e,t,r)=>{"use strict";var a=r(7260);r.o(a,"useRouter")&&r.d(t,{useRouter:function(){return a.useRouter}})},796:(e,t,r)=>{Promise.resolve().then(r.bind(r,9673))},8712:(e,t,r)=>{"use strict";r.d(t,{WithAuth:()=>i,A:()=>s});var a=r(5155),l=r(2115);let o=(0,l.createContext)(void 0);function n(e){let{children:t}=e,[r,n]=(0,l.useState)(null),[s,i]=(0,l.useState)(!0),c=async()=>{try{let e=await fetch("/api/auth/me",{credentials:"include"});if(e.ok){let t=await e.json();n(t)}else n(null)}catch(e){console.error("Failed to fetch user:",e),n(null)}finally{i(!1)}},d=async(e,t)=>{try{let r=await fetch("/api/auth/login",{method:"POST",headers:{"Content-Type":"application/json"},credentials:"include",body:JSON.stringify({username:e,password:t})});if(r.ok){let e=await r.json();return n(e),!0}return!1}catch(e){return console.error("Login failed:",e),!1}},u=async()=>{try{await fetch("/api/auth/logout",{method:"POST",credentials:"include"})}catch(e){console.error("Logout failed:",e)}n(null)},g=async()=>{await c()};return(0,l.useEffect)(()=>{c()},[]),(0,a.jsx)(o.Provider,{value:{user:r,loading:s,login:d,logout:u,refreshUser:g},children:t})}function s(){let e=(0,l.useContext)(o);if(void 0===e)throw Error("useAuth must be used within an AuthProvider");return e}function i(e){let{children:t}=e;return(0,a.jsx)(n,{children:t})}},9673:(e,t,r)=>{"use strict";r.r(t),r.d(t,{default:()=>p});var a=r(5155),l=r(2115),o=r(63),n=r(8712);function s(e){var t,r,l,o,n,s,i,c,d;let{node:u,onClick:g,onEdit:f,onDelete:h,onConnectionStart:p,onConnectionEnd:m,onHandleClick:x,isConnecting:b,isConnectingSource:w,isSelected:_}=e;return(0,a.jsxs)("div",{className:"absolute flex flex-col justify-center items-start p-3 rounded-r-lg cursor-pointer group ".concat((e=>{let t="border-l-4 shadow-lg backdrop-blur-sm bg-gray-900/90 transition-all hover:translate-y-[-2px] hover:shadow-xl";switch(e){case"crawler":return"".concat(t," border-blue-500 shadow-blue-900/20");case"translator":return"".concat(t," border-purple-500 shadow-purple-900/20");case"forwarder":return"".concat(t," border-orange-500 shadow-orange-900/20");case"formatter":return"".concat(t," border-pink-500 shadow-pink-900/20");case"target":return"".concat(t," border-green-500 shadow-green-900/20");default:return"".concat(t," border-gray-500")}})(u.type)," ").concat(_?"ring-2 ring-yellow-400 z-30":"z-10"),style:{left:u.x,top:u.y,width:u.width,height:u.height},onClick:e=>{e.stopPropagation(),g(u,{shiftKey:e.shiftKey||e.metaKey||e.ctrlKey})},onDoubleClick:e=>{e.stopPropagation(),null==f||f(u)},children:[(0,a.jsx)("div",{className:"text-white font-bold text-sm w-full break-words whitespace-normal leading-snug mb-1",title:u.label,children:u.label}),(0,a.jsx)("div",{className:"text-xs text-white/40 uppercase tracking-widest font-mono",children:u.type}),(null==(t=u.data)?void 0:t.enabled)===!1&&(0,a.jsx)("div",{className:"absolute top-2 right-2 w-2 h-2 rounded-full bg-red-500",title:"Disabled"}),("crawler"===u.type||"forwarder"===u.type)&&(null==(l=u.data)||null==(r=l.cfg_crawler)?void 0:r.cron)&&(0,a.jsx)("div",{className:"absolute bottom-2 right-2 text-[10px] text-white/50 font-mono bg-white/10 px-1 rounded",children:null==(n=u.data)||null==(o=n.cfg_crawler)?void 0:o.cron}),("crawler"===u.type||"forwarder"===u.type)&&(null==(i=u.data)||null==(s=i.cfg_forwarder)?void 0:s.cron)&&(0,a.jsx)("div",{className:"absolute bottom-2 right-2 text-[10px] text-white/50 font-mono bg-white/10 px-1 rounded",children:null==(d=u.data)||null==(c=d.cfg_forwarder)?void 0:c.cron}),_&&(0,a.jsxs)("div",{className:"absolute -top-10 left-0 flex gap-2 animate-fadeIn z-50",children:[(0,a.jsxs)("button",{onClick:e=>{e.stopPropagation(),null==f||f(u)},className:"px-2 py-1 bg-blue-600 hover:bg-blue-500 text-white text-xs rounded shadow-lg transition-colors flex items-center gap-1",children:[(0,a.jsx)("span",{children:"✏️"})," Edit"]}),h&&(0,a.jsx)("button",{onClick:e=>{e.stopPropagation(),confirm("Delete this node?")&&h(u.id)},className:"px-2 py-1 bg-red-600 hover:bg-red-500 text-white text-xs rounded shadow-lg transition-colors",children:"\uD83D\uDDD1️"})]}),("crawler"===u.type||"translator"===u.type||"formatter"===u.type||"forwarder"===u.type)&&(0,a.jsx)("div",{className:"absolute right-0 top-1/2 -translate-y-1/2 translate-x-1/2 w-4 h-4 rounded-full border-2 cursor-pointer transition-all z-20 ".concat(w?"bg-blue-500 border-blue-300 ring-2 ring-blue-500 ring-opacity-50 scale-125":"bg-white/20 border-white/40 hover:bg-white/40 hover:scale-125"),onMouseDown:e=>{e.stopPropagation(),0===e.button&&(null==p||p(u.id,"output"))},onClick:e=>{e.stopPropagation(),null==x||x(u.id,"output")},title:"Drag or Click to connect"}),("translator"===u.type||"formatter"===u.type||"target"===u.type)&&(0,a.jsx)("div",{className:"absolute left-0 top-1/2 -translate-y-1/2 -translate-x-1/2 w-4 h-4 rounded-full border-2 cursor-pointer transition-all z-20 ".concat(b?"bg-green-500/50 border-green-400 animate-pulse hover:!bg-green-500 hover:scale-125":"bg-white/20 border-white/40 hover:bg-white/40 hover:scale-125"),onMouseUp:e=>{e.stopPropagation(),null==m||m(u.id,"input")},onClick:e=>{e.stopPropagation(),null==x||x(u.id,"input")},title:"Connect here"})]})}function i(e){let{node:t,onSave:r,onClose:o,availableCookies:n=[]}=e,[s,i]=(0,l.useState)({}),[g,f]=(0,l.useState)(""),[h,p]=(0,l.useState)(!1);(0,l.useEffect)(()=>{var e,r,a,l,o,n,s,c,d,u,g,f,h,p,m,x,b,w,_,y,v,j,k;if("crawler"===t.type){let g=t.data;i({name:g.name,task_type:g.task_type||"article",cron:(null==(e=g.cfg_crawler)?void 0:e.cron)||"",cookie_file:(null==(r=g.cfg_crawler)?void 0:r.cookie_file)||"",engine:(null==(a=g.cfg_crawler)?void 0:a.engine)||"browser",websites:g.websites?g.websites.join("\n"):"",origin:g.origin||"",paths:g.paths?g.paths.join("\n"):"",sub_task_type:(null==(l=g.cfg_crawler)?void 0:l.sub_task_type)?g.cfg_crawler.sub_task_type.join("\n"):"",interval_min:(null==(n=g.cfg_crawler)||null==(o=n.interval_time)?void 0:o.min)||"",interval_max:(null==(c=g.cfg_crawler)||null==(s=c.interval_time)?void 0:s.max)||"",user_agent:(null==(d=g.cfg_crawler)?void 0:d.user_agent)||"",immediate_notify:(null==(u=g.cfg_crawler)?void 0:u.immediate_notify)||!1,group:g.group||"",raw_config:JSON.stringify(g.cfg_crawler||{},null,2)})}else if("translator"===t.type){let e=t.data;i({id:e.id||"",name:e.name||"",provider:e.provider||"Google",api_key:e.api_key||"",model_id:(null==(g=e.cfg_translator)?void 0:g.model_id)||"",prompt:(null==(f=e.cfg_translator)?void 0:f.prompt)||"",base_url:(null==(h=e.cfg_translator)?void 0:h.base_url)||"",group:e.group||"",raw_config:JSON.stringify(e.cfg_translator||{},null,2)})}else if("forwarder"===t.type){let e=t.data;i({id:e.id,name:e.name,task_type:e.task_type||"article",cron:(null==(p=e.cfg_forwarder)?void 0:p.cron)||"",render_type:(null==(m=e.cfg_forwarder)?void 0:m.render_type)||"text",websites:e.websites?e.websites.join("\n"):"",origin:e.origin||"",paths:e.paths?e.paths.join("\n"):"",task_title:e.task_title||"",subscribers:e.subscribers?e.subscribers.map(e=>"string"==typeof e?e:e.id):[],accept_keywords:(null==(x=e.cfg_forward_target)?void 0:x.accept_keywords)?e.cfg_forward_target.accept_keywords.join("\n"):"",filter_keywords:(null==(b=e.cfg_forward_target)?void 0:b.filter_keywords)?e.cfg_forward_target.filter_keywords.join("\n"):"",group:e.group||"",raw_config:JSON.stringify(e.cfg_forwarder||{},null,2),block_rules:JSON.stringify((null==(w=e.cfg_forward_target)?void 0:w.block_rules)||[],null,2)})}else if("formatter"===t.type)i({id:t.data.id||"",name:t.data.name||"",render_type:t.data.render_type||"text",group:t.data.group||""});else if("target"===t.type){let e=t.data,r=e.cfg_platform||{};i({platform:e.platform,id:e.id,replace_regex:JSON.stringify((null==(_=e.cfg_platform)?void 0:_.replace_regex)||"",null,2),block_until:(null==(y=e.cfg_platform)?void 0:y.block_until)||"",accept_keywords:(null==(v=e.cfg_platform)?void 0:v.accept_keywords)?e.cfg_platform.accept_keywords.join("\n"):"",filter_keywords:(null==(j=e.cfg_platform)?void 0:j.filter_keywords)?e.cfg_platform.filter_keywords.join("\n"):"",tg_token:r.token||"",tg_chat_id:r.chat_id||"",qq_url:r.url||"",qq_group_id:r.group_id||"",qq_token:r.token||"",bili_sessdata:r.sessdata||"",bili_jct:r.bili_jct||"",bili_media_check:r.media_check_level||"loose",json_config:JSON.stringify(e.cfg_platform,null,2),group:e.group||"",block_rules:JSON.stringify((null==(k=e.cfg_platform)?void 0:k.block_rules)||[],null,2)})}},[t]);let m=(e,t)=>{i(r=>({...r,[e]:t}))},x=async e=>{if(e){p(!0);try{let t=await fetch("/api/cookies/view/".concat(encodeURIComponent(e.replace(".txt",""))));if(!t.ok)throw Error("Failed to fetch cookie file");let r=(await t.json()).content.split("\n"),a="",l="";for(let e of r){if(e.startsWith("#")||!e.trim())continue;let t=e.split("	");if(t.length>=7){let e=t[5],r=t[6];"SESSDATA"===e&&(a=r.trim()),"bili_jct"===e&&(l=r.trim())}}a&&l?(i(e=>({...e,bili_sessdata:a,bili_jct:l})),alert("Successfully imported credentials from ".concat(e))):alert("Could not find SESSDATA or bili_jct in the selected cookie file.")}catch(e){alert("Import failed: ".concat(e.message))}finally{p(!1)}}};return(0,a.jsx)("div",{className:"fixed inset-0 bg-black/50 backdrop-blur-sm flex items-center justify-center z-50 p-8",children:(0,a.jsxs)("div",{className:"bg-gray-900 border border-white/20 rounded-2xl w-full max-w-2xl max-h-full overflow-y-auto shadow-2xl flex flex-col",children:[(0,a.jsxs)("div",{className:"p-6 border-b border-white/10 flex justify-between items-center",children:[(0,a.jsxs)("h2",{className:"text-2xl font-bold text-white flex items-center gap-2",children:["Config: ",t.label]}),(0,a.jsx)("button",{onClick:o,className:"text-white/60 hover:text-white",children:"✕"})]}),(0,a.jsxs)("div",{className:"p-6 space-y-6 flex-grow overflow-auto",children:["crawler"===t.type&&(0,a.jsxs)(a.Fragment,{children:[(0,a.jsxs)("div",{className:"grid grid-cols-2 gap-4",children:[(0,a.jsx)(c,{label:"Name",value:s.name,onChange:e=>m("name",e)}),(0,a.jsx)(c,{label:"Group Tag",value:s.group,onChange:e=>m("group",e),placeholder:"Grouping label"})]}),(0,a.jsx)("div",{className:"grid grid-cols-2 gap-4",children:(0,a.jsx)(u,{label:"Task Type",value:s.task_type,options:["article","follows"],onChange:e=>m("task_type",e)})}),(0,a.jsx)("h3",{className:"text-sm font-bold text-blue-300 border-b border-blue-500/30 pb-1 mt-4",children:"Target Source"}),(0,a.jsx)(c,{label:"Origin (e.g. Username)",value:s.origin,onChange:e=>m("origin",e),placeholder:"@username"}),(0,a.jsx)(d,{label:"Paths (e.g. List ID)",value:s.paths,onChange:e=>m("paths",e),placeholder:"One path per line"}),(0,a.jsx)(d,{label:"Websites (Override)",value:s.websites,onChange:e=>m("websites",e),placeholder:"https://..."}),(0,a.jsx)("h3",{className:"text-sm font-bold text-blue-300 border-b border-blue-500/30 pb-1 mt-4",children:"Execution"}),(0,a.jsxs)("div",{className:"grid grid-cols-2 gap-4",children:[(0,a.jsx)(c,{label:"Cron Schedule",value:s.cron,onChange:e=>m("cron",e),placeholder:"* * * * *"}),(0,a.jsx)(u,{label:"Engine",value:s.engine,options:["browser","cheerio","axios"],onChange:e=>m("engine",e)})]}),(0,a.jsx)(u,{label:"Cookie File",value:s.cookie_file,options:["",...n],onChange:e=>m("cookie_file",e)}),(0,a.jsxs)("div",{className:"grid grid-cols-2 gap-4",children:[(0,a.jsx)(c,{label:"Interval Min (ms)",value:s.interval_min,onChange:e=>m("interval_min",e),type:"number"}),(0,a.jsx)(c,{label:"Interval Max (ms)",value:s.interval_max,onChange:e=>m("interval_max",e),type:"number"})]}),(0,a.jsxs)("div",{className:"grid grid-cols-2 gap-4",children:[(0,a.jsx)(c,{label:"User Agent",value:s.user_agent,onChange:e=>m("user_agent",e)}),(0,a.jsx)("div",{className:"flex items-center pt-6",children:(0,a.jsxs)("label",{className:"flex items-center gap-2 cursor-pointer text-sm text-white/80",children:[(0,a.jsx)("input",{type:"checkbox",checked:s.immediate_notify,onChange:e=>m("immediate_notify",e.target.checked),className:"rounded border-white/20 bg-black/30"}),"Immediate Notify"]})})]}),(0,a.jsx)(d,{label:"Sub Task Types",value:s.sub_task_type,onChange:e=>m("sub_task_type",e),placeholder:"One per line"}),(0,a.jsx)("h3",{className:"text-sm font-bold text-gray-400 border-b border-gray-500/30 pb-1 mt-4",children:"Advanced: Raw Config"}),(0,a.jsx)("div",{className:"text-xs text-white/40 mb-2",children:"Edits here will override individual fields above."}),(0,a.jsx)(d,{label:"JSON Config",value:s.raw_config,onChange:e=>m("raw_config",e),fontMono:!0})]}),"translator"===t.type&&(0,a.jsxs)(a.Fragment,{children:[(0,a.jsx)("div",{className:"mb-4 bg-purple-500/10 p-3 rounded border border-purple-500/30 text-xs text-purple-200",children:t.data.id?"Independent translator node":"Legacy translator attached to crawler"}),(0,a.jsxs)("div",{className:"grid grid-cols-2 gap-4",children:[(0,a.jsx)(c,{label:"ID (Auto-generated if empty)",value:s.id,onChange:e=>m("id",e),placeholder:"translator-1"}),(0,a.jsx)(c,{label:"Name",value:s.name,onChange:e=>m("name",e),placeholder:"My Translator"})]}),(0,a.jsx)(c,{label:"Group Tag",value:s.group,onChange:e=>m("group",e),placeholder:"Grouping label"}),(0,a.jsx)(u,{label:"Provider",value:s.provider,options:["Google","BigModel","Deepseek","Openai","ByteDance","None"],onChange:e=>m("provider",e)}),(0,a.jsx)(c,{label:"API Key",value:s.api_key,onChange:e=>m("api_key",e),type:"password"}),(0,a.jsx)(c,{label:"Base URL",value:s.base_url,onChange:e=>m("base_url",e),placeholder:"Optional"}),(0,a.jsx)(c,{label:"Model ID",value:s.model_id,onChange:e=>m("model_id",e)}),(0,a.jsx)(d,{label:"System Prompt",value:s.prompt,onChange:e=>m("prompt",e)}),(0,a.jsx)("h3",{className:"text-sm font-bold text-gray-400 border-b border-gray-500/30 pb-1 mt-4",children:"Advanced: Raw Config"}),(0,a.jsx)(d,{label:"JSON Config",value:s.raw_config,onChange:e=>m("raw_config",e),fontMono:!0})]}),"forwarder"===t.type&&(0,a.jsxs)(a.Fragment,{children:[(0,a.jsxs)("div",{className:"grid grid-cols-2 gap-4",children:[(0,a.jsx)(c,{label:"ID (Optional)",value:s.id,onChange:e=>m("id",e),placeholder:"forwarder-1"}),(0,a.jsx)(c,{label:"Name",value:s.name,onChange:e=>m("name",e)})]}),(0,a.jsx)(c,{label:"Group Tag",value:s.group,onChange:e=>m("group",e),placeholder:"Grouping label"}),(0,a.jsx)(c,{label:"Task Title",value:s.task_title,onChange:e=>m("task_title",e)}),(0,a.jsx)(u,{label:"Task Type",value:s.task_type,options:["article","follows"],onChange:e=>m("task_type",e)}),(0,a.jsx)("h3",{className:"text-sm font-bold text-orange-300 border-b border-orange-500/30 pb-1 mt-4",children:"Source Matcher"}),(0,a.jsx)("div",{className:"text-xs text-white/50 mb-2",children:"Configure these to match the source Crawler."}),(0,a.jsx)(c,{label:"Origin (Username)",value:s.origin,onChange:e=>m("origin",e)}),(0,a.jsx)(d,{label:"Paths (List ID)",value:s.paths,onChange:e=>m("paths",e)}),(0,a.jsx)(d,{label:"Websites (Exact URL)",value:s.websites,onChange:e=>m("websites",e)}),(0,a.jsx)("h3",{className:"text-sm font-bold text-orange-300 border-b border-orange-500/30 pb-1 mt-4",children:"Formatter & Execution"}),(0,a.jsx)(u,{label:"Render Type (Formatter)",value:s.render_type,options:[{label:"Text Only",value:"text"},{label:"Standard Image Card",value:"img"},{label:"Image with Metadata",value:"img-with-meta"},{label:"Image with Source Label",value:"img-with-source"},{label:"Image with Source + Summary",value:"img-with-source-summary"}],onChange:e=>m("render_type",e)}),(0,a.jsx)(c,{label:"Execution Cron",value:s.cron,onChange:e=>m("cron",e),placeholder:"* * * * *"}),(0,a.jsxs)("div",{className:"grid grid-cols-2 gap-4",children:[(0,a.jsx)(d,{label:"Accept Keywords",value:s.accept_keywords,onChange:e=>m("accept_keywords",e),placeholder:"One per line",fontMono:!0}),(0,a.jsx)(d,{label:"Filter Keywords (Block)",value:s.filter_keywords,onChange:e=>m("filter_keywords",e),placeholder:"One per line",fontMono:!0})]})]}),"formatter"===t.type&&(0,a.jsxs)(a.Fragment,{children:[(0,a.jsx)("div",{className:"mb-4 bg-pink-500/10 p-3 rounded border border-pink-500/30 text-xs text-pink-200",children:"This formatter determines how content is rendered before sending to targets."}),(0,a.jsxs)("div",{className:"grid grid-cols-2 gap-4",children:[(0,a.jsx)(c,{label:"ID (Auto-generated if empty)",value:s.id,onChange:e=>m("id",e),placeholder:"formatter-1"}),(0,a.jsx)(c,{label:"Name (Optional)",value:s.name,onChange:e=>m("name",e),placeholder:"My Formatter"})]}),(0,a.jsx)(u,{label:"Format / Layout",value:s.render_type,options:[{label:"Text Only",value:"text"},{label:"Standard Image Card",value:"img"},{label:"Image with Metadata",value:"img-with-meta"},{label:"Image with Source Label",value:"img-with-source"},{label:"Image with Source + Summary",value:"img-with-source-summary"}],onChange:e=>m("render_type",e)})]}),"target"===t.type&&(0,a.jsxs)(a.Fragment,{children:[(0,a.jsx)(u,{label:"Platform",value:s.platform,options:["telegram","bilibili","qq","none"],onChange:e=>m("platform",e)}),(0,a.jsx)(c,{label:"Unique ID (Optional)",value:s.id,onChange:e=>m("id",e),placeholder:"Leave blank for auto-hash"}),(0,a.jsxs)("div",{className:"p-4 bg-white/5 rounded-lg border border-white/10 space-y-4",children:["telegram"===s.platform&&(0,a.jsxs)(a.Fragment,{children:[(0,a.jsx)("h3",{className:"font-bold text-sm text-blue-300",children:"Telegram"}),(0,a.jsx)(c,{label:"Bot Token",value:s.tg_token,onChange:e=>m("tg_token",e)}),(0,a.jsx)(c,{label:"Chat ID",value:s.tg_chat_id,onChange:e=>m("tg_chat_id",e)})]}),"qq"===s.platform&&(0,a.jsxs)(a.Fragment,{children:[(0,a.jsx)("h3",{className:"font-bold text-sm text-blue-300",children:"QQ"}),(0,a.jsx)(c,{label:"API URL",value:s.qq_url,onChange:e=>m("qq_url",e)}),(0,a.jsx)(c,{label:"Token",value:s.qq_token,onChange:e=>m("qq_token",e)}),(0,a.jsx)(c,{label:"Group ID",value:s.qq_group_id,onChange:e=>m("qq_group_id",e)})]}),"bilibili"===s.platform&&(0,a.jsxs)(a.Fragment,{children:[(0,a.jsx)("h3",{className:"font-bold text-sm text-pink-300",children:"Bilibili"}),(0,a.jsx)("div",{className:"flex gap-2 items-end",children:(0,a.jsx)(u,{label:"Import from Cookie",value:"",options:["...",...n],onChange:x})}),(0,a.jsx)(c,{label:"SESSDATA",value:s.bili_sessdata,onChange:e=>m("bili_sessdata",e),type:"password"}),(0,a.jsx)(c,{label:"Bili JCT",value:s.bili_jct,onChange:e=>m("bili_jct",e),type:"password"})]})]}),(0,a.jsxs)("div",{className:"mt-4 pt-4 border-t border-white/10",children:[(0,a.jsx)("h3",{className:"font-bold text-sm text-white/60 mb-2",children:"Global Rules"}),(0,a.jsxs)("div",{className:"grid grid-cols-2 gap-4",children:[(0,a.jsx)(d,{label:"Accept Keywords",value:s.accept_keywords,onChange:e=>m("accept_keywords",e),placeholder:"One per line",fontMono:!0}),(0,a.jsx)(d,{label:"Filter Keywords",value:s.filter_keywords,onChange:e=>m("filter_keywords",e),placeholder:"One per line",fontMono:!0})]}),(0,a.jsx)(d,{label:"Replace Regex (String or JSON)",value:s.replace_regex,onChange:e=>m("replace_regex",e),fontMono:!0}),(0,a.jsx)(c,{label:"Block Until (Time)",value:s.block_until,onChange:e=>m("block_until",e),placeholder:"e.g. 1h"})]})]})]}),(0,a.jsxs)("div",{className:"p-6 border-t border-white/10 bg-black/20 flex justify-end gap-3",children:[(0,a.jsx)("button",{onClick:o,className:"px-4 py-2 rounded-lg text-white/70 hover:bg-white/10 transition-colors",children:"Cancel"}),(0,a.jsx)("button",{onClick:()=>{let e={...t.data},a=e=>e?e.split("\n").map(e=>e.trim()).filter(Boolean):void 0;if("crawler"===t.type){e.name=s.name,e.task_type=s.task_type,e.websites=a(s.websites),e.origin=s.origin,e.paths=a(s.paths),e.cfg_crawler||(e.cfg_crawler={}),e.cfg_crawler.cron=s.cron,e.cfg_crawler.cookie_file=s.cookie_file,e.cfg_crawler.engine=s.engine,e.cfg_crawler.sub_task_type=a(s.sub_task_type),(s.interval_min||s.interval_max)&&(e.cfg_crawler.interval_time={min:parseInt(s.interval_min)||0,max:parseInt(s.interval_max)||0}),e.cfg_crawler.user_agent=s.user_agent,e.cfg_crawler.immediate_notify=s.immediate_notify,e.group=s.group;try{if(s.raw_config){let t=JSON.parse(s.raw_config);Object.assign(e.cfg_crawler,t)}}catch(e){}}else if("translator"===t.type){e.id=s.id||t.data.id,e.name=s.name,e.provider=s.provider,e.api_key=s.api_key,e.cfg_translator||(e.cfg_translator={}),e.cfg_translator.model_id=s.model_id,e.cfg_translator.prompt=s.prompt,e.cfg_translator.base_url=s.base_url,e.group=s.group;try{if(s.raw_config){let t=JSON.parse(s.raw_config);Object.assign(e.cfg_translator,t)}}catch(e){}}else if("forwarder"===t.type){e.id=s.id||t.data.id,e.name=s.name,e.task_type=s.task_type,e.task_title=s.task_title,e.websites=a(s.websites),e.origin=s.origin,e.paths=a(s.paths),e.cfg_forwarder||(e.cfg_forwarder={}),e.cfg_forwarder.cron=s.cron,e.cfg_forwarder.render_type=s.render_type,e.cfg_forward_target||(e.cfg_forward_target={}),e.cfg_forward_target.accept_keywords=a(s.accept_keywords),e.cfg_forward_target.filter_keywords=a(s.filter_keywords),e.group=s.group;try{s.block_rules&&(e.cfg_forward_target.block_rules=JSON.parse(s.block_rules))}catch(e){}try{if(s.raw_config){let t=JSON.parse(s.raw_config);Object.assign(e.cfg_forwarder,t)}}catch(e){}}else if("formatter"===t.type)e.id=s.id||t.data.id,e.name=s.name,e.render_type=s.render_type,e.group=s.group;else if("target"===t.type){e.platform=s.platform,e.id=s.id;let t={};if("telegram"===s.platform)t.token=s.tg_token,t.chat_id=s.tg_chat_id;else if("qq"===s.platform)t.url=s.qq_url,t.group_id=s.qq_group_id,t.token=s.qq_token;else if("bilibili"===s.platform)t.sessdata=s.bili_sessdata,t.bili_jct=s.bili_jct,t.media_check_level=s.bili_media_check;else try{let e=JSON.parse(s.json_config||"{}");Object.assign(t,e)}catch(e){}try{s.replace_regex&&(s.replace_regex.trim().startsWith("[")||s.replace_regex.trim().startsWith('"'))?t.replace_regex=JSON.parse(s.replace_regex):t.replace_regex=s.replace_regex}catch(e){t.replace_regex=s.replace_regex}s.block_until&&(t.block_until=s.block_until),t.accept_keywords=a(s.accept_keywords),t.filter_keywords=a(s.filter_keywords),e.cfg_platform=t,e.group=s.group;try{s.block_rules&&(e.cfg_platform.block_rules=JSON.parse(s.block_rules))}catch(e){}}r(t,e)},className:"px-4 py-2 bg-blue-600 hover:bg-blue-700 text-white rounded-lg transition-colors font-medium",children:"Save Changes"})]})]})})}function c(e){let{label:t,value:r,onChange:l,type:o="text",placeholder:n}=e;return(0,a.jsxs)("div",{children:[(0,a.jsx)("label",{className:"block text-sm font-medium text-white/80 mb-1",children:t}),(0,a.jsx)("input",{type:o,value:r||"",onChange:e=>l(e.target.value),placeholder:n,className:"w-full px-4 py-2 bg-black/30 border border-white/10 rounded-lg text-white placeholder-white/30 focus:outline-none focus:ring-2 focus:ring-blue-500"})]})}function d(e){let{label:t,value:r,onChange:l,fontMono:o}=e;return(0,a.jsxs)("div",{children:[(0,a.jsx)("label",{className:"block text-sm font-medium text-white/80 mb-1",children:t}),(0,a.jsx)("textarea",{rows:4,value:r||"",onChange:e=>l(e.target.value),className:"w-full px-4 py-2 bg-black/30 border border-white/10 rounded-lg text-white placeholder-white/30 focus:outline-none focus:ring-2 focus:ring-blue-500 ".concat(o?"font-mono text-xs":"")})]})}function u(e){let{label:t,value:r,options:l,onChange:o}=e;return(0,a.jsxs)("div",{className:"flex-grow",children:[(0,a.jsx)("label",{className:"block text-sm font-medium text-white/80 mb-1",children:t}),(0,a.jsx)("select",{value:r||"",onChange:e=>o(e.target.value),className:"w-full px-4 py-2 bg-black/30 border border-white/10 rounded-lg text-white focus:outline-none focus:ring-2 focus:ring-blue-500 appearance-none",children:l.map(e=>{let t="object"==typeof e?e.label:e,r="object"==typeof e?e.value:e;return(0,a.jsx)("option",{value:r,children:t},r)})})]})}function g(e){let{originalConfig:t,newConfig:r,onCancel:o,onConfirm:n}=e,s=(0,l.useMemo)(()=>(function(e,t){let r=e.split("\n"),a=t.split("\n"),l=r.length,o=a.length,n=Array(l+1).fill(0).map(()=>Array(o+1).fill(0));for(let e=1;e<=l;e++)for(let t=1;t<=o;t++)r[e-1]===a[t-1]?n[e][t]=n[e-1][t-1]+1:n[e][t]=Math.max(n[e-1][t],n[e][t-1]);let s=[],i=l,c=o;for(;i>0||c>0;)i>0&&c>0&&r[i-1]===a[c-1]?(s.unshift({type:"same",content:r[i-1],line:i}),i--,c--):c>0&&(0===i||n[i][c-1]>=n[i-1][c])?(s.unshift({type:"add",content:a[c-1],line:null}),c--):i>0&&(0===c||n[i][c-1]<n[i-1][c])&&(s.unshift({type:"remove",content:r[i-1],line:i}),i--);return s})(JSON.stringify(t,null,2),JSON.stringify(r,null,2)),[t,r]),i=s.filter(e=>"add"===e.type).length,c=s.filter(e=>"remove"===e.type).length;return(0,a.jsx)("div",{className:"fixed inset-0 bg-black/80 flex items-center justify-center z-50 p-8",children:(0,a.jsxs)("div",{className:"bg-[#1a1a1a] border border-white/10 rounded-xl max-w-5xl w-full h-full max-h-[90vh] shadow-2xl flex flex-col",children:[(0,a.jsxs)("div",{className:"p-6 border-b border-white/10 flex justify-between items-center",children:[(0,a.jsx)("div",{children:(0,a.jsxs)("h2",{className:"text-xl font-bold text-white flex items-center gap-3",children:["Review Changes",(0,a.jsxs)("span",{className:"text-sm font-normal bg-white/10 px-2 py-0.5 rounded text-white/60",children:[i," additions, ",c," deletions"]})]})}),(0,a.jsx)("button",{onClick:o,className:"text-white/60 hover:text-white",children:"✕"})]}),(0,a.jsx)("div",{className:"flex-grow overflow-auto p-0 bg-[#0d1117]",children:(0,a.jsx)("div",{className:"font-mono text-xs md:text-sm",children:s.map((e,t)=>{let r="",l="text-gray-300",o=" ";return"add"===e.type?(r="bg-green-900/30",l="text-green-300",o="+"):"remove"===e.type?(r="bg-red-900/30",l="text-red-300 line-through opacity-70",o="-"):(l="text-gray-500",o=" "),(0,a.jsxs)("div",{className:"flex ".concat(r," hover:bg-white/5 transition-colors"),children:[(0,a.jsx)("div",{className:"w-10 flex-shrink-0 text-right pr-3 select-none text-white/20 border-r border-white/10 mr-3",children:e.line||" "}),(0,a.jsx)("div",{className:"w-6 flex-shrink-0 select-none text-white/40",children:o}),(0,a.jsx)("div",{className:"whitespace-pre-wrap break-all flex-grow ".concat(l),children:e.content})]},t)})})}),(0,a.jsxs)("div",{className:"p-6 border-t border-white/10 bg-[#1a1a1a] flex justify-end gap-3",children:[(0,a.jsx)("button",{onClick:o,className:"px-4 py-2 bg-white/5 hover:bg-white/10 text-white rounded-lg transition-colors",children:"Keep Editing"}),(0,a.jsxs)("button",{onClick:n,className:"px-4 py-2 bg-green-600 hover:bg-green-700 text-white rounded-lg font-medium transition-colors shadow-lg shadow-green-900/20 flex items-center gap-2",children:[(0,a.jsx)("span",{children:"\uD83D\uDCBE"})," Confirm & Save"]})]})]})})}var f=r(6671),h=r.n(f);function p(){let{user:e,loading:t}=(0,n.A)(),r=(0,o.useRouter)(),[c,d]=(0,l.useState)(null),[u,f]=(0,l.useState)(null),[p,m]=(0,l.useState)(!1),[x,b]=(0,l.useState)([]),[w,_]=(0,l.useState)([]),[y,v]=(0,l.useState)([]),[j,k]=(0,l.useState)(!1),[N,C]=(0,l.useState)(""),[S,O]=(0,l.useState)(null),[E,D]=(0,l.useState)(!1),[I,T]=(0,l.useState)(!1),[M,A]=(0,l.useState)(null),[R,q]=(0,l.useState)(!1),[F,P]=(0,l.useState)(!1),[J,L]=(0,l.useState)(null),[z,G]=(0,l.useState)(null),[B,U]=(0,l.useState)({x:0,y:0}),K=(0,l.useRef)(null),[W,H]=(0,l.useState)(new Set),[Q,X]=(0,l.useState)({width:2e3,height:1500});(0,l.useEffect)(()=>{t||e||r.push("/auth/login?redirect=/config")},[e,t,r]),(0,l.useEffect)(()=>{e&&Z()},[e]);let[Y,V]=(0,l.useState)([]),Z=async()=>{k(!0),C("");try{let[e,t]=await Promise.all([fetch("/api/config"),fetch("/api/cookies/list")]);if(401===e.status||401===t.status)return void r.push("/auth/login?redirect=/config");if(!e.ok)throw Error("Failed to fetch config");let a=await e.json();if(d(a),f(h().cloneDeep(a)),m(!1),m(!1),H(new Set),$(a),t.ok){let e=await t.json();V(e.map(e=>e.filename))}}catch(e){C(e instanceof Error?e.message:"Failed to load data")}finally{k(!1)}},$=e=>{let t=[],r=[],a=e.crawlers||[],l=e.forwarders||[],o=e.translators||[],n=e.formatters||[],s=e.forward_targets||[],i=(e,t,r)=>r||"".concat(e,"-").concat(t);a.forEach((e,r)=>{let a=i("crawler",r,e.name);t.push({id:a,type:"crawler",label:e.name||"Crawler ".concat(r+1),data:e,x:50,y:120*r+100,width:250,height:100})}),l.forEach((e,r)=>{let l=i("forwarder",r,e.id);t.push({id:l,type:"forwarder",label:e.name||"Forwarder ".concat(r+1),data:e,x:50,y:(a.length+r)*120+120,width:250,height:100})}),o.forEach((e,r)=>{let a=i("translator",r,e.id);t.push({id:a,type:"translator",label:e.name||"".concat(e.provider," Translator"),data:e,x:400,y:120*r+100,width:250,height:100})}),a.forEach((e,a)=>{var l;if((null==(l=e.cfg_crawler)?void 0:l.translator)&&!e.cfg_crawler.translator_id){let l="translator-legacy-".concat(a);t.push({id:l,type:"translator",label:"".concat(e.cfg_crawler.translator.provider," (Legacy)"),data:e.cfg_crawler.translator,x:400,y:(o.length+a)*120+100,width:250,height:100,parentId:i("crawler",a,e.name)}),r.push({id:"conn-c-t-legacy-".concat(a),source:i("crawler",a,e.name),target:l,type:"crawler-translator"})}}),n.forEach((e,r)=>{let a=i("formatter",r,e.id),l=(()=>{switch(e.render_type){case"text":return"Text Only";case"img":return"Image Card";case"img-with-meta":return"Image + Meta";case"img-with-source":return"Image + Source";case"img-with-source-summary":return"Image + Source + Summary";default:return e.name||e.render_type}})();t.push({id:a,type:"formatter",label:e.name||l,data:e,x:750,y:120*r+100,width:250,height:100})}),s.forEach((e,r)=>{let a=i("target",r,e.id);t.push({id:a,type:"target",label:"".concat(e.platform," (").concat(e.id||"Global",")"),data:e,x:1100,y:120*r+100,width:250,height:100})});let c=e.connections||{};Object.entries(c["crawler-translator"]||{}).forEach(e=>{let[t,a]=e;r.push({id:"conn-ct-".concat(t,"-").concat(a),source:t,target:a,type:"crawler-translator"})}),Object.entries(c["translator-formatter"]||{}).forEach(e=>{let[t,a]=e;a.forEach(e=>{r.push({id:"conn-tf-".concat(t,"-").concat(e),source:t,target:e,type:"translator-formatter"})})}),Object.entries(c["crawler-formatter"]||{}).forEach(e=>{let[t,a]=e;a.forEach(e=>{r.push({id:"conn-cf-".concat(t,"-").concat(e),source:t,target:e,type:"crawler-formatter"})})}),Object.entries(c["formatter-target"]||{}).forEach(e=>{let[t,a]=e;a.forEach(e=>{r.push({id:"conn-ft-".concat(t,"-").concat(e),source:t,target:e,type:"formatter-target"})})}),Object.entries(c["forwarder-target"]||{}).forEach(e=>{let[t,a]=e;a.forEach(e=>{r.push({id:"conn-ft-direct-".concat(t,"-").concat(e),source:t,target:e,type:"forwarder-target"})})}),X({width:Math.max(...t.map(e=>e.x+e.width),1500)+500,height:Math.max(...t.map(e=>e.y+e.height),1e3)+500});let d=new Map;t.forEach(e=>{e.data.group&&(d.has(e.data.group)||d.set(e.data.group,[]),d.get(e.data.group).push(e))});let u=Array.from(d.entries()).map((e,t)=>{let[r,a]=e,l=Math.min(...a.map(e=>e.x)),o=Math.min(...a.map(e=>e.y)),n=Math.max(...a.map(e=>e.x+e.width)),s=Math.max(...a.map(e=>e.y+e.height)),i=["#3b82f6","#8b5cf6","#ec4899","#f59e0b","#10b981","#ef4444"],c=r.split("").reduce((e,t)=>e+t.charCodeAt(0),0)%i.length;return{id:"group-".concat(r),label:r,x:l-20,y:o-40,width:n-l+40,height:s-o+60,color:i[c]}});b(t),_(r),v(u)},ee=async(e,t)=>{var r,a,l;if(!c)return;let o=h().cloneDeep(c),n=e.id.split("-"),s=n[0];if("crawler"===s){let a=null==(r=o.crawlers)?void 0:r.findIndex(t=>{var r;return t.name===e.data.name||(null==(r=o.crawlers)?void 0:r.indexOf(t))===parseInt(n[1])});void 0!==a&&a>=0&&o.crawlers&&(o.crawlers[a]=t)}else if("translator"===s)if("legacy"===n[1]){let e=parseInt(n[2]);o.crawlers&&o.crawlers[e]&&(o.crawlers[e].cfg_crawler||(o.crawlers[e].cfg_crawler={}),o.crawlers[e].cfg_crawler.translator=t)}else{o.translators||(o.translators=[]);let r=o.translators.findIndex(t=>{var r;return t.id===e.data.id||(null==(r=o.translators)?void 0:r.indexOf(t))===parseInt(n[1])});r>=0?o.translators[r]=t:o.translators.push(t)}else if("formatter"===s){o.formatters||(o.formatters=[]);let r=o.formatters.findIndex(t=>{var r;return t.id===e.data.id||(null==(r=o.formatters)?void 0:r.indexOf(t))===parseInt(n[1])});r>=0?o.formatters[r]=t:o.formatters.push(t)}else if("forwarder"===s){let r=null==(a=o.forwarders)?void 0:a.findIndex(t=>{var r;return t.id===e.data.id||(null==(r=o.forwarders)?void 0:r.indexOf(t))===parseInt(n[1])});if(void 0!==r&&r>=0&&o.forwarders)o.forwarders[r]=t;else if(o.forwarders){let e=parseInt(n[1]);o.forwarders[e]&&(o.forwarders[e]=t)}}else if("target"===s){let r=null==(l=o.forward_targets)?void 0:l.findIndex(t=>{var r;return t.id===e.data.id||(null==(r=o.forward_targets)?void 0:r.indexOf(t))===parseInt(n[1])});void 0!==r&&r>=0&&o.forward_targets&&(o.forward_targets[r]=t)}d(o),$(o),A(null),m(!0)},et=(e,t)=>{P(!0),L(e)},er=(e,t)=>{var r;let a=J||z;if(!a||a===e){P(!1),L(null),G(null);return}let l=x.find(e=>e.id===a),o=x.find(t=>t.id===e);if(!(l&&o&&(null==(r=({crawler:["translator","formatter"],translator:["formatter"],formatter:["target"],forwarder:["target"]})[l.type])?void 0:r.includes(o.type)))){alert("Invalid connection! Please follow: Crawler → Translator/Formatter, Translator → Formatter, Formatter → Target"),P(!1),L(null),G(null);return}el(a,e),P(!1),L(null),G(null)},ea=(e,t)=>{"output"===t?z===e?G(null):G(e):"input"===t&&z&&er(e,"input")},el=(e,t)=>{if(!c)return;if(w.some(r=>r.source===e&&r.target===t))return void alert("Connection already exists!");let r=x.find(t=>t.id===e),a=x.find(e=>e.id===t);if(!r||!a)return;let l="".concat(r.type,"-").concat(a.type),o={id:"conn-".concat(e,"-").concat(t,"-").concat(Date.now()),source:e,target:t,type:l};_(e=>[...e,o]);let n=h().cloneDeep(c);n.connections||(n.connections={}),"crawler-translator"===l?(n.connections["crawler-translator"]||(n.connections["crawler-translator"]={}),n.connections["crawler-translator"][e]=t):"translator-formatter"===l?(n.connections["translator-formatter"]||(n.connections["translator-formatter"]={}),n.connections["translator-formatter"][e]||(n.connections["translator-formatter"][e]=[]),n.connections["translator-formatter"][e].push(t)):"crawler-formatter"===l?(n.connections["crawler-formatter"]||(n.connections["crawler-formatter"]={}),n.connections["crawler-formatter"][e]||(n.connections["crawler-formatter"][e]=[]),n.connections["crawler-formatter"][e].push(t)):"formatter-target"===l?(n.connections["formatter-target"]||(n.connections["formatter-target"]={}),n.connections["formatter-target"][e]||(n.connections["formatter-target"][e]=[]),n.connections["formatter-target"][e]||(n.connections["formatter-target"][e]=[]),n.connections["formatter-target"][e].push(t)):"forwarder-target"===l&&(n.connections["forwarder-target"]||(n.connections["forwarder-target"]={}),n.connections["forwarder-target"][e]||(n.connections["forwarder-target"][e]=[]),n.connections["forwarder-target"][e].push(t)),d(n),m(!0)},eo=(e,t)=>{let r=new Set(t.shiftKey?W:[]);r.has(e.id)?r.delete(e.id):r.add(e.id),H(r)},en=e=>{A(e)},es=e=>{alert("Node deletion logic to be implemented in implementation_plan.md next phases.")},ei=async e=>{try{if(O("Saving..."),!(await fetch("/api/config/update",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify(e)})).ok)throw Error("Failed to save to backend");O("Saved successfully! Restart server to apply.")}catch(e){O("Error saving: ".concat(e.message))}},ec=async()=>{if(confirm("Are you sure you want to restart the backend server? This will interrupt active tasks.")){q(!0),O("Restarting server...");try{if(!(await fetch("/api/server/restart",{method:"POST"})).ok)throw Error("Restart request failed");O("Server restart command sent. Please wait for service to recover."),setTimeout(()=>{q(!1),O("Server should be back up. Refresh if needed.")},5e3)}catch(e){O("Restart Error: ".concat(e.message)),q(!1)}}};return t||!e?(0,a.jsx)("div",{className:"min-h-screen bg-black flex items-center justify-center text-white",children:"Loading..."}):(0,a.jsxs)("div",{className:"min-h-screen bg-[#111] text-white overflow-hidden flex flex-col",children:[(0,a.jsxs)("div",{className:"bg-[#1a1a1a] border-b border-white/10 p-4 flex justify-between items-center z-10 shadow-md",children:[(0,a.jsxs)("div",{className:"flex items-center gap-3",children:[(0,a.jsxs)("h1",{className:"text-xl font-bold flex items-center gap-2",children:[(0,a.jsx)("span",{children:"⚙️"})," Configuration Graph"]}),S&&(0,a.jsx)("span",{className:"text-xs px-2 py-1 rounded ".concat(S.includes("Error")?"bg-red-500/20 text-red-300":"bg-green-500/20 text-green-300"),children:S}),p&&(0,a.jsx)("span",{className:"text-xs px-2 py-1 rounded bg-yellow-500/20 text-yellow-300 animate-pulse font-bold",children:"● Unsaved Changes"})]}),(0,a.jsxs)("div",{className:"flex gap-3",children:[c&&p&&(0,a.jsxs)("button",{onClick:()=>T(!0),className:"px-4 py-1 bg-green-600 hover:bg-green-700 text-white rounded font-bold shadow-lg shadow-green-900/20 transition-all flex items-center gap-2",children:[(0,a.jsx)("span",{children:"\uD83D\uDCBE"})," Save Changes"]}),(0,a.jsx)("button",{onClick:()=>D(!E),className:"px-3 py-1 rounded text-sm transition-colors ".concat(E?"bg-purple-600 text-white":"bg-white/5 hover:bg-white/10"),children:"Debug Info"}),(0,a.jsx)("button",{onClick:Z,className:"px-3 py-1 bg-white/5 hover:bg-white/10 rounded text-sm transition-colors",disabled:j,children:p?"Discard & Refresh":"Refresh"}),(0,a.jsx)("button",{onClick:ec,disabled:R,className:"px-3 py-1 bg-red-600 hover:bg-red-700 text-white rounded text-sm transition-colors flex items-center gap-2 ".concat(R?"opacity-50 cursor-not-allowed":""),children:R?"Restarting...":"Restart Server"})]})]}),(0,a.jsx)("div",{ref:K,className:"flex-grow relative overflow-auto bg-[url('/grid.svg')] bg-fixed",style:{backgroundSize:"20px 20px"},onMouseMove:e=>{if(F&&K.current){let t=K.current.getBoundingClientRect();U({x:e.clientX-t.left+K.current.scrollLeft,y:e.clientY-t.top+K.current.scrollTop})}},onMouseUp:()=>{F&&(P(!1),L(null),G(null))},onClick:()=>{z&&G(null),F||H(new Set)},children:(0,a.jsxs)("div",{className:"absolute inset-0",style:{minWidth:Q.width,minHeight:Q.height},children:[(0,a.jsxs)("div",{className:"absolute top-4 right-4 z-20 flex flex-col gap-2",children:[W.size>1&&(0,a.jsxs)("button",{onClick:()=>{if(0===W.size)return;let e=prompt("Enter group name:");if(!e)return;let t=h().cloneDeep(c);t&&(W.forEach(r=>{let a=x.find(e=>e.id===r);if(!a)return;let l=r.split("-"),o=l[0],n=parseInt(l[1]);if("crawler"===o){var s;if(null==(s=t.crawlers)||s.find(e=>{var r;return e===a.data||(null==(r=t.crawlers)?void 0:r.indexOf(e))===n}),t.crawlers){let r=t.crawlers.find(e=>e.name===a.data.name);r&&(r.group=e)}}}),x.filter(e=>W.has(e.id)).forEach(r=>{var a,l,o,n,s;let[i]=r.id.split("-");if("crawler"===i){let l=null==(a=t.crawlers)?void 0:a.find(e=>e.name===r.data.name);l&&(l.group=e)}else if("forwarder"===i){let a=null==(l=t.forwarders)?void 0:l.find(e=>e.id===r.data.id||e.name===r.data.name);a&&(a.group=e)}else if("formatter"===i){let a=null==(o=t.formatters)?void 0:o.find(e=>e.id===r.data.id);a&&(a.group=e)}else if("target"===i){let a=null==(n=t.forward_targets)?void 0:n.find(e=>e.id===r.data.id);a&&(a.group=e)}else if("translator"===i){let a=null==(s=t.translators)?void 0:s.find(e=>e.id===r.data.id);a&&(a.group=e)}}),d(t),$(t),m(!0),H(new Set))},className:"px-4 py-2 bg-indigo-600 hover:bg-indigo-700 text-white rounded-lg shadow-lg flex items-center gap-2 text-sm font-medium transition-all hover:scale-105 animate-fade-in",children:[(0,a.jsx)("span",{className:"text-lg",children:"⚓"})," Create Group"]}),(0,a.jsxs)("button",{onClick:()=>{if(!c)return;let e={name:"New Crawler ".concat(Date.now()),cron:"0 * * * *",websites:[],paths:[],task_type:"article"},t=h().cloneDeep(c);t.crawlers||(t.crawlers=[]),t.crawlers.push(e),d(t),$(t),m(!0)},className:"px-4 py-2 bg-blue-600 hover:bg-blue-700 text-white rounded-lg shadow-lg flex items-center gap-2 text-sm font-medium transition-all hover:scale-105",children:[(0,a.jsx)("span",{className:"text-lg",children:"+"})," Add Crawler"]}),(0,a.jsxs)("button",{onClick:()=>{if(!c)return;let e={id:"formatter-".concat(Date.now()),name:"New Formatter",render_type:"text"},t=h().cloneDeep(c);t.formatters||(t.formatters=[]),t.formatters.push(e),d(t),$(t),m(!0)},className:"px-4 py-2 bg-pink-600 hover:bg-pink-700 text-white rounded-lg shadow-lg flex items-center gap-2 text-sm font-medium transition-all hover:scale-105",children:[(0,a.jsx)("span",{className:"text-lg",children:"+"})," Add Formatter"]}),(0,a.jsxs)("button",{onClick:()=>{if(!c)return;let e={platform:"telegram",id:"target-".concat(Date.now()),cfg_platform:{}},t=h().cloneDeep(c);t.forward_targets||(t.forward_targets=[]),t.forward_targets.push(e),d(t),$(t),m(!0)},className:"px-4 py-2 bg-green-600 hover:bg-green-700 text-white rounded-lg shadow-lg flex items-center gap-2 text-sm font-medium transition-all hover:scale-105",children:[(0,a.jsx)("span",{className:"text-lg",children:"+"})," Add Target"]})]}),(0,a.jsx)("div",{className:"absolute inset-0 pointer-events-none z-0",children:y.map(e=>(0,a.jsx)("div",{className:"absolute border-2 rounded-xl transition-all",style:{left:e.x,top:e.y,width:e.width,height:e.height,borderColor:e.color,backgroundColor:"".concat(e.color,"10")},children:(0,a.jsx)("div",{className:"absolute -top-3 left-4 px-2 text-xs font-bold text-white rounded uppercase tracking-wider",style:{backgroundColor:e.color},children:e.label})},e.id))}),(0,a.jsxs)("svg",{className:"absolute inset-0 w-full h-full pointer-events-none z-0",children:[w.map(e=>{let t=x.find(t=>t.id===e.source),r=x.find(t=>t.id===e.target);if(!t||!r)return null;let l=t.x+t.width,o=t.y+t.height/2,n=r.x,s=r.y+r.height/2,i="crawler-translator"===e.type?"#8b5cf6":"translator-formatter"===e.type?"#ec4899":"crawler-formatter"===e.type?"#f59e0b":"formatter-target"===e.type?"#10b981":"forwarder-target"===e.type?"#c026d3":"#6b7280",u=W.has(e.source)||W.has(e.target);return(0,a.jsxs)("g",{className:"group",children:[(0,a.jsx)("path",{d:"M ".concat(l," ").concat(o," C ").concat(l+50," ").concat(o,", ").concat(n-50," ").concat(s,", ").concat(n," ").concat(s),fill:"none",stroke:"transparent",strokeWidth:"20",className:"cursor-pointer",style:{pointerEvents:"stroke"},onClick:t=>{t.stopPropagation(),confirm("Delete this connection?")&&(e=>{if(!c)return;let t=w.find(t=>t.id===e);if(!t)return;_(t=>t.filter(t=>t.id!==e));let r=h().cloneDeep(c);if(!r.connections)return;let a=r.connections[t.type];if(a){if("crawler-translator"===t.type)delete a[t.source];else{let e=a[t.source];e&&(a[t.source]=e.filter(e=>e!==t.target))}d(r),m(!0)}})(e.id)},onMouseEnter:()=>{}}),(0,a.jsx)("path",{d:"M ".concat(l," ").concat(o," C ").concat(l+50," ").concat(o,", ").concat(n-50," ").concat(s,", ").concat(n," ").concat(s),fill:"none",stroke:u?"#ffffff":i,strokeWidth:u?"3":"2",strokeDasharray:u?"none":"5,5",className:"pointer-events-none group-hover:stroke-red-500 group-hover:stroke-width-4 transition-all",style:{opacity:u?1:.6,filter:u?"drop-shadow(0 0 5px rgba(255,255,255,0.5))":"none"}})]},e.id)}),F&&J&&(()=>{let e=x.find(e=>e.id===J);if(!e)return null;let t=e.x+e.width,r=e.y+e.height/2;return(0,a.jsx)("line",{x1:t,y1:r,x2:B.x,y2:B.y,stroke:"#4ade80",strokeWidth:"3",strokeDasharray:"5,5",opacity:"0.7"})})()]}),0===x.length&&!j&&(0,a.jsx)("div",{className:"absolute inset-0 flex items-center justify-center pointer-events-none",children:(0,a.jsxs)("div",{className:"text-center p-8 bg-black/50 backdrop-blur-md rounded-xl border border-white/10 select-none pointer-events-auto",children:[(0,a.jsx)("div",{className:"text-4xl mb-4",children:"\uD83D\uDD78️"}),(0,a.jsx)("h3",{className:"text-xl font-bold text-white mb-2",children:"No Configuration Found"}),(0,a.jsxs)("p",{className:"text-white/60 max-w-md",children:["The crawler/forwarder graph is empty. Please check your backend ",(0,a.jsx)("code",{children:"config.yaml"})," or check console for errors."]})]})}),x.map(e=>(0,a.jsx)(s,{node:e,onClick:eo,onEdit:en,onDelete:es,isSelected:W.has(e.id),onConnectionStart:et,onConnectionEnd:er,onHandleClick:ea,isConnecting:F||!!z,isConnectingSource:z===e.id},e.id)),(0,a.jsx)("div",{className:"absolute top-4 left-[50px] text-white/20 font-bold text-xl",children:"CRAWLERS"}),(0,a.jsx)("div",{className:"absolute top-4 left-[400px] text-white/20 font-bold text-xl",children:"TRANSLATORS"}),(0,a.jsx)("div",{className:"absolute top-4 left-[750px] text-white/20 font-bold text-xl",children:"FORMATTERS"}),(0,a.jsx)("div",{className:"absolute top-4 left-[1100px] text-white/20 font-bold text-xl",children:"TARGETS"})]})}),E&&c&&(0,a.jsxs)("div",{className:"h-64 border-t border-white/10 bg-black/90 p-4 font-mono text-xs overflow-auto",children:[(0,a.jsxs)("div",{className:"flex justify-between items-center mb-2",children:[(0,a.jsx)("h3",{className:"font-bold text-lg text-purple-300",children:"Backend Config Debug"}),(0,a.jsx)("button",{onClick:()=>D(!1),className:"text-white/60 hover:text-white",children:"✕ Close"})]}),(0,a.jsx)("pre",{className:"text-green-400 whitespace-pre-wrap",children:JSON.stringify(c,null,2)})]}),M&&c&&(0,a.jsx)(i,{node:M,fullConfig:c,availableCookies:Y,onSave:ee,onClose:()=>A(null)}),I&&c&&u&&(0,a.jsx)(g,{originalConfig:u,newConfig:c,onCancel:()=>T(!1),onConfirm:()=>{ei(c),T(!1),m(!1),f(h().cloneDeep(c))}})]})}}},e=>{e.O(0,[935,441,255,358],()=>e(e.s=796)),_N_E=e.O()}]);